---
title: "stock_EDA_and_visualization"
output: html_document
date: "2025-10-30"
---

## Knitting
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries
```{r}
library(ggrepel)
library(forcats)
library(tidyverse)
library(readr)
library(dplyr)
library(stringr)
library(purrr)
library(tidyquant)
library(lubridate)
library(ggplot2)
library(tidyr)
```

# Loading Data
```{r}
data_path = "data/"

all_files = list.files(path = data_path,
                      pattern = "*.csv",
                      full.names = TRUE)
#seeing if files were found
print("--- Checking for files... ---")
if (length(all_files) == 0) {
  print("No .csv files were found in the 'data/' folder.")
} else {
  print("Found the following files:")
  print(all_files)
  
  all_stocks_df = all_files %>%
    set_names(.) %>%
    map_dfr(read_csv, .id = "Stock") %>%
    
    mutate(Stock = str_remove(Stock, data_path),
           Stock = str_remove(Stock, ".csv"))

  print("--- Data successfully loaded! ---")
  print(head(all_stocks_df))
}
```


# Checking for missing values
```{r}
print(paste("Total missing values:", sum(is.na(all_stocks_df))))

# Start and end dates for EACH stock
date_ranges = all_stocks_df %>%
  group_by(Stock) %>%
  summarize(
    StartDate = min(Date),
    EndDate = max(Date),
    TotalDays = n()
  ) %>%
  arrange(StartDate)

print("--- Date Ranges by Stock ---")
print(date_ranges)

#Note-- due to scraping method, there are no missing values
```

# Calculates daily % return for every stock
```{r}
all_returns_df = all_stocks_df %>%
  group_by(Stock) %>%
  tq_mutate(
    select     = Close,            
    mutate_fun = periodReturn,     
    period     = "daily",          
    col_rename = "Daily.Return"   
  ) %>%
  ungroup() %>%
  na.omit() 

print(head(all_returns_df))
```

# S&P 500 line chart
```{r}
gspc_df = all_stocks_df %>%
  filter(Stock == "^GSPC")

ggplot(gspc_df, aes(x = Date, y = Close)) +
  geom_line(color = "purple") +
  labs(title = "S&P 500 (^GSPC) Closing Price Over Time",
       y = "Price (USD)",
       x = "Date") +
  theme_tq()

# Shows major crashes in 2000, 2008, 2020, extremely high climb up to 2025
```

# Analyzes risk using all_returns_df
```{r}
ggplot(all_returns_df, aes(x = Stock, y = Daily.Return, fill = Stock)) +
  geom_boxplot() +
  
#Zoom in on the most common returns (-10% to +10%)
  coord_cartesian(ylim = c(-0.1, 0.1)) + 
  labs(title = "Volatility (Distribution of Daily Returns)",
       y = "Daily Return", x = "Stock Ticker") +
  theme_tq() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 8),
        legend.position = "none")

# hiding legend, too busy
```

# Correlations
```{r}
# matrix with stocks as columns and dates as rows
wide_returns_df <- all_returns_df %>%
  pivot_wider(id_cols = Date, 
              names_from = Stock, 
              values_from = Daily.Return) %>%
  select(-Date)

# correlation matrix
cor_matrix <- cor(wide_returns_df, use = "complete.obs")

cor_long <- as.data.frame(as.table(cor_matrix))
colnames(cor_long) <- c("Stock1", "Stock2", "Correlation")

# heatmap
ggplot(cor_long, aes(x = Stock1, y = Stock2, fill = Correlation)) +
  geom_tile() + 

  scale_fill_gradient2(low = "blue", mid = "white", high = "red", 
                       midpoint = 0, limit = c(-1, 1),
                       name = "Correlation") +
                       
  labs(title = "Correlation Heatmap of Daily Stock Returns") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8),
        axis.text.y = element_text(size = 8),
        axis.title.x = element_blank(),
        axis.title.y = element_blank())

# Darkest red stocks follow the market most closely, tech, bank clusters of stocks are all highly correlated
```

# Sorted Bar Chart to expand on most vs least volatile
```{r}
# standard deviation (volatility) for each stock
volatility_df <- all_returns_df %>%
  group_by(Stock) %>%
  summarize(
    Volatility = sd(Daily.Return)
  ) %>%
  ungroup()

ggplot(volatility_df, aes(x = Volatility, y = fct_reorder(Stock, Volatility))) +
  geom_col(fill = "steelblue") +
  labs(title = "Stock Volatility (Ranked)",
       subtitle = "Based on Standard Deviation of Daily Returns",
       x = "Volatility (Higher = Riskier)",
       y = "Stock Ticker") +
  theme_tq()
```

# Cumulative returns (long term performance)
```{r}
cumulative_returns_df <- all_returns_df %>%
  group_by(Stock) %>%
  mutate(
    Cumulative.Return = cumprod(1 + Daily.Return)
  ) %>%
  ungroup()

ggplot(cumulative_returns_df, aes(x = Date, y = Cumulative.Return, color = Stock)) +
  geom_line() +
  labs(title = "Cumulative Performance (Growth of $1)",
       subtitle = "Starting value = $1. Logarithmic scale.",
       y = "Growth of $1 (Log Scale)",
       x = "Date") +
  
  scale_y_log10() + 
  theme_tq() +
  theme(legend.position = "none") 
```

# Mapping stocks to sectors
```{r}
# tibble to map stocks to sectors
sector_map <- tibble(
  Stock = c('^GSPC', 'AAPL', 'MSFT', 'NVDA', 'GOOGL', 'META', 'AVGO', 'CSCO', 
            'ADBE', 'CRM', 'INTC', 'JPM', 'BAC', 'WFC', 'GS', 'MS', 'BLK', 
            'AXP', 'SCHW', 'UNH', 'JNJ', 'LLY', 'ABBV', 'MRK', 'PFE', 'TMO', 
            'AMZN', 'TSLA', 'HD', 'MCD', 'NKE', 'SBUX', 'WMT', 'PG', 'KO', 
            'PEP', 'BA', 'CAT', 'UPS', 'RTX', 'HON', 'XOM', 'CVX', 'COP', 
            'DIS', 'NFLX', 'CMCSA', 'NEE', 'DUK', 'AMT', 'PLD'),
  Sector = c('Market', 'Technology', 'Technology', 'Technology', 'Technology', 
             'Technology', 'Technology', 'Technology', 'Technology', 'Technology', 
             'Technology', 'Financials', 'Financials', 'Financials', 
             'Financials', 'Financials', 'Financials', 'Financials', 
             'Financials', 'Healthcare', 'Healthcare', 'Healthcare', 
             'Healthcare', 'Healthcare', 'Healthcare', 'Healthcare', 
             'Consumer Discretionary', 'Consumer Discretionary', 
             'Consumer Discretionary', 'Consumer Discretionary', 
             'Consumer Discretionary', 'Consumer Discretionary', 
             'Consumer Staples', 'Consumer Staples', 'Consumer Staples', 
             'Consumer Staples', 'Industrials', 'Industrials', 'Industrials', 
             'Industrials', 'Industrials', 'Energy', 'Energy', 'Energy', 
             'Communication Services', 'Communication Services', 
             'Communication Services', 'Utilities', 'Utilities', 'Real Estate', 
             'Real Estate')
)

# joins the sector map to your returns data
returns_with_sectors_df <- all_returns_df %>%
  left_join(sector_map, by = "Stock")

# average volatility for each sector
sector_volatility <- returns_with_sectors_df %>%
  group_by(Sector) %>%
  summarize(
    Avg_Volatility = mean(Daily.Return, na.rm = TRUE), 
    StdDev_Volatility = sd(Daily.Return, na.rm = TRUE) 
  ) %>%
  filter(Sector != "Market") 

ggplot(sector_volatility, aes(x = StdDev_Volatility, y = fct_reorder(Sector, StdDev_Volatility))) +
  geom_col(fill = "green") +
  labs(title = "Sector Volatility (Risk)",
       subtitle = "Based on Standard Deviation of Daily Returns",
       x = "Volatility (Higher = Riskier)",
       y = "Sector") +
  theme_tq()
```

# Risk v. Return
```{r}
risk_return_summary <- all_returns_df %>%
  group_by(Stock) %>%
  summarize(
    Avg_Return = mean(Daily.Return),
    Volatility = sd(Daily.Return)
  ) %>%
  ungroup() %>%
  filter(Stock != "^GSPC")


ggplot(risk_return_summary, aes(x = Volatility, y = Avg_Return)) +
  geom_point(alpha = 0.5, color = "blue") +
  geom_text_repel(aes(label = Stock), size = 3) +
  geom_hline(yintercept = mean(risk_return_summary$Avg_Return), 
             linetype = "dashed", color = "grey") +
  geom_vline(xintercept = mean(risk_return_summary$Volatility), 
             linetype = "dashed", color = "grey") +
  
  labs(title = "Risk vs. Return (2000-Present)",
       subtitle = "Based on Daily Returns",
       x = "Volatility (Risk)",
       y = "Average Daily Return (Performance)") +
  theme_tq()
```

# Growth 
```{r}
cumulative_with_sectors_df <- cumulative_returns_df %>%
  left_join(sector_map, by = "Stock")

sector_performance_df <- cumulative_with_sectors_df %>%
  group_by(Sector, Date) %>%
  summarize(
    Avg_Cumulative_Return = mean(Cumulative.Return, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(Sector != "Market")

ggplot(sector_performance_df, aes(x = Date, y = Avg_Cumulative_Return, color = Sector)) +
  geom_line(linewidth = 1) +
  scale_y_log10() +
  labs(title = "Average Sector Performance (Growth of $1)",
       y = "Average Growth of $1 (Log Scale)",
       x = "Date",
       color = "Sector") +
  theme_tq()
```


